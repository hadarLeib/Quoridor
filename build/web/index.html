










\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\<!DOCTYPE html>
 
<html>
    <head>
        <title>Echo Chamber</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        	<meta name="author" content="Ranjdar Abass">
	<!--	<link rel="shortcut icon" href="/images/ranj.png" />
		<link rel="stylesheet" href="/css/quoridor.css" />
	-->	
		<style>
		#board {
	width: 530px;
	height: 530px;
	float: left;
}
.square, .fence {
	float: left;
}
.square {
	width: 50px;
	height: 50px;
	background-color: #742;
}
.fence {
	width: 10px;
	height: 50px;
	background-color: #c75;
}
.fence.selected, .fence.placed {
	background-color: #cc5;
}
.fence.horizontal {
	height: 10px;
	width: 50px;
	padding: 0 5px;
}
.fence.horizontal.left {
	padding-left: 0;
}
.fence.horizontal.right {
	padding-left: 0;
}
#player_1, #player_2 {
	height: 80%;
	width: 80%;
	margin: 10%;
	border-radius: 2em;
}
#player_1 {
	background-color: #fff;
}
#player_2 {
	background-color: #000;
}
#info{
	float:left;
}
		
		</style>
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
		<!--<script type="text/javascript" src="/js/quoridor.js"></script> -->
		
		<script>
		
		var Quoridor = new function() {
	this.boardDimension = 9;
	this.startingFences = 10;
	this.player1=null;
	this.player2=null;
	this.moves=null;
	this.currentTurn = null;
	this.init = function(board){
		var board = $(board);
		
		for(var i = 0; i < this.boardDimension; i++) {
			if(i != 0) {
				for(var j = 0; j < this.boardDimension; j++) {
					var horizontalFence = $('<div class="fence horizontal" />')
					if(j == 0) {
						horizontalFence.addClass('left');
					}
					if(j == 8) {
						horizontalFence.addClass('right');
					}
					board.append(horizontalFence);
				}
			}
			for( var j = 0; j < this.boardDimension; j++) {
				var squareNumber = (i * this.boardDimension) + j;
				var square = $('<div id="square_' + squareNumber + '" class="square" />')
				if(j != 0) {
					var fence = $('<div class="fence" />')
					board.append(fence);
				}
				board.append(square);
			}
		}
		initPlayers();
		bindSquareEventHandlers();
		bindFenceEventHandlers();		
		updateInformation();
		board.after(Information.getPanel());
	}
	 function bindFenceEventHandlers() {
		$('.fence').each(function(i, v) {
			$(v).attr('id', 'fence_' + i);
		});
		$('.fence').hover(function() {
			$(this).addClass('selected');
			getAdjacentFence(this).addClass('selected');
		}, function() {
			$(this).removeClass('selected');
			getAdjacentFence(this).removeClass('selected');
		});
		$('.fence').click(function() {
			placeFence(this);
		});
	}
	function bindSquareEventHandlers () {
		$('.square').click(function() {
			var newPosition = parseInt($(this).attr('id').split('_')[1]);
			movePlayer(newPosition);
		});
	}
	 function initPlayers () {
		this.player1 = new Player("Player 1", 4, "player_1", Quoridor.startingFences);
		this.player2 = new Player("Player 2", 76, "player_2", Quoridor.startingFences);
		
		currentTurn = this.player1;
		
		updatePlayerPosition(this.currentTurn.pos);
		switchPlayer();
		updatePlayerPosition(this.currentTurn.pos);
		switchPlayer();		
	}
	
	function movePlayer (newPosition){
		if(isPossibleMove(newPosition)){
			updatePlayerPosition(newPosition);
			switchPlayer();
			checkWinner();
		}
	}
	
	function isPossibleMove (newPosition){
		var isLegal = true;

		return (isAdjacentSquare(newPosition) && isLegal);
	}
	
	function isAdjacentSquare(newPosition){
		var isAdjacentSquare = false;
		var adjacentSquares = getAdjacentSquares();
		$.each(adjacentSquares,function(i, v){
			if(newPosition == v){
				isAdjacentSquare = true;
			}
		});
		return isAdjacentSquare;
	}
	
	function getAdjacentSquares(){
		var adjacentSquares = [];
		getAdjacentVerticalSquares(adjacentSquares);
		getAdjacentHorizontalSquares(adjacentSquares);
		return adjacentSquares;
	}
	
	function getAdjacentVerticalSquares(adjacentSquares){	
		var boardDimension = Quoridor.boardDimension;
		if(currentTurn.pos < boardDimension){
			adjacentSquares.push(currentTurn.pos + boardDimension);
		}
		else if(currentTurn.pos > (boardDimension * boardDimension)-boardDimension){
			adjacentSquares.push(currentTurn.pos - boardDimension);
		}
		else
		{
			adjacentSquares.push(currentTurn.pos + boardDimension);
			adjacentSquares.push(currentTurn.pos - boardDimension);
		}
	}
	
	function getAdjacentHorizontalSquares(adjacentSquares){	
		if(currentTurn.pos % 9 == 0){
			adjacentSquares.push(currentTurn.pos + 1);
		}
		else if(currentTurn.pos % 9 == 8){
			adjacentSquares.push(currentTurn.pos - 1);
		}
		else
		{
			adjacentSquares.push(currentTurn.pos + 1);
			adjacentSquares.push(currentTurn.pos - 1);
		}
	}
	
	function updatePlayerPosition (position){	
		this.currentTurn.pos = position;
		var playerDiv = $('<div id="' + this.currentTurn.id + '" />');
		$('#' + this.currentTurn.id).remove();
		$('#square_' + position).append(playerDiv);
	}
	
	function getAdjacentFence (fence) {
		if($(fence).hasClass('horizontal')) {
			return $(fence).next();
		}
		else {
			adjacentIndex = parseInt($(fence).attr('id').split('_')[1]) + 17;
			return $($('.fence')[adjacentIndex]);
		}

	}
	
function isFencePlaceable (fence) {
	var isLegal = true;
	var nextFence = getAdjacentFence(fence);

	var fenceId = parseInt($(fence).attr('id').split('_')[1]);
	var nextFenceId;

	if($(fence).hasClass("placed")){
		alert("There is a fence already there");
		$(isLegal) = false;
	}


	if($(nextFence).hasClass("placed")){
		alert("There is a fence already there");
		$(isLegal) = false;
	}


// find vertical cross
	if(($(fence).hasClass("horizontal"))){
		nextFenceId = parseInt($(nextFence).attr('id').split('_')[1]);
		topVertical = fenceId - 8;
		bottomVertical = fenceId + 9;

		if($($('.fence')[topVertical]).hasClass('placed') && $($('.fence')[bottomVertical]).hasClass('placed')){
			alert("There is a fence already there");
			$(isLegal) = false;
		}

		if((nextFenceId) != (fenceId+1)){
			alert("out of bounds");
			$(isLegal) = false;
		}

	}
	else{
		leftHorizontal = fenceId + 8;
		rightHorizontal = fenceId + 9;;
		if($($('.fence')[leftHorizontal]).hasClass('placed') && $($('.fence')[rightHorizontal]).hasClass('placed')){
			alert("There is a fence already there");
			$(isLegal) = false;
		}
		if(fenceId>135){
			alert("out of bounds");
			$(isLegal) = false;
		}
	}

	if(!hasFencesRemaining()){
		alert("No fences left");
		$(isLegal) = false;
	}

	return (isLegal);
}
	
	function hasFencesRemaining(){
		return this.currentTurn.fencesRemaining > 0;
	}
	
	function placeFence (fence) {
		if(isFencePlaceable(fence)){
			$(fence).addClass('placed');
			getAdjacentFence(fence).addClass('placed');
                        updateGraphFence(fence); 
			this.currentTurn.fencesRemaining--;
			switchPlayer();
		}
	}

	function updateGraphFence(fence){
		//vertical (a/b - c/d)
		// a | b
		// c | d

		//horizontal (a/b - c/d)
		// a c
		// _ _
		// b d

		var a;
		var b;
		var c;
		var d;
                var fType;
                var idArr = [];
              
		var fenceId = parseInt($(fence).attr('id').split('_')[1]);
		var nextFence = getAdjacentFence(fence);
		var nextFenceId = parseInt($(nextFence).attr('id').split('_')[1]);

		if(($(fence).hasClass("horizontal"))){
			a = fenceId - 8;
			b = fenceId + 1;
			c = nextFenceId - 8;
			d = nextFenceId + 1;
                        fType = "h";
		}

		else{
			a = fenceId - (8 * (fenceId/17));
			b = a + 1;
			c = nextFenceId - (8 * (fenceId/17));
			d = c + 1;
                        fType = "v";
		}
               
		//send json
                sendFence(a, b, c, d, fType);
	}

	function updateInformation(){
		Information.currentTurn.text(this.currentTurn.name);
		Information.player1FencesRemaining.text(this.player1.fencesRemaining);
		Information.player2FencesRemaining.text(this.player2.fencesRemaining);
	}

	function checkWinner(){
		if (this.player1.pos > 71){
			alert("white won");
		}
		else if (this.player2.pos < 9){
			alert("black won");
		}
	}
	
	function switchPlayer(){
		if(this.currentTurn == this.player1){
			this.currentTurn = this.player2;
		}
		else{
			this.currentTurn = this.player1;
		}
		updateInformation();
	}
};

var Information = new function(){
	this.panel = $('<div id="info" />');
	this.currentTurn = $('<div id="currentTurn" />');
	this.player1FencesRemaining = $('<div id="player1FencesRemaining" />');
	this.player2FencesRemaining = $('<div id="player2FencesRemaining" />'); 
	this.getPanel = function(){
		this.panel.append(this.currentTurn);
		this.panel.append(this.player1FencesRemaining);
		this.panel.append(this.player2FencesRemaining);
		return this.panel;
	}
	
}

function Player(name, position, id, fences){
	this.name = name;
	this.pos = position;
	this.id = id;
	this.fencesRemaining = fences;
}

$(function() {
	Quoridor.init('#board');
});
</script>

    </head>
    <body>
       <div id="board"></div>
        <div>
            <input type="text" id="messageinput"/>
        </div>
        <div>
            <button type="button" onclick="openSocket();" >Open</button>
            <button type="button" onclick="send();" >Send</button>
            <button type="button" onclick="closeSocket();" >Close</button>
        </div>
        <!-- Server responses get written here -->
        <div id="messages"></div>
       
        <!-- Script to utilise the WebSocket -->
        <script type="text/javascript">
                       
            var webSocket;
            var messages = document.getElementById("messages");
           
           
            function openSocket(){
                // Ensures only one connection is open at a time
                if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
                   writeResponse("WebSocket is already opened.");
                    return;
                }
                // Create a new instance of the websocket
                webSocket = new WebSocket("ws://localhost:8080/quoridor4/echo");
                 
                /**
                 * Binds functions to the listeners for the websocket.
                 */
                webSocket.onopen = function(event){
                    // For reasons I can't determine, onopen gets called twice
                    // and the first time event.data is undefined.
                    // Leave a comment if you know the answer.
                    if(event.data === undefined)
                        return;
 
                    writeResponse(event.data);
                };
 
                webSocket.onmessage = function(event){
                    
                    var obj = JSON.parse(event.data);
                   
                    if (typeof obj == "object"){
                        //Json
                        writeResponse(obj.name + "," + obj.message );
                    }
                    else {
                        //Not Json
                        writeResponse(event.data);
                    }
                    
                };
 
                webSocket.onclose = function(event){
                    writeResponse("Connection closed");
                };
            }
           
            /**
             * Sends the value of the text input to the server
             */
            function send(){
                var text = document.getElementById("messageinput").value;
                
                var obj  = {"message":text, "name" : "hadar"};
                
                                webSocket.send(JSON.stringify(obj));

            }
            
            function sendFence(a, b, c, d, fType){
                
                var obj  = {type : "f", a : a, b : b, c : c, d : d, fType : fType};
//                var obj  = {"message" : fType, "name" : "hadar"};
                                webSocket.send(JSON.stringify(obj));

            }
            function sendMove(){
                var text = document.getElementById("messageinput").value;
                
                
                
                                webSocket.send(JSON.stringify(obj));

            }
           
            function closeSocket(){
                webSocket.close();
            }
 
            function writeResponse(text){
                messages.innerHTML += "<br/>" + text;
            }
           
        </script>
       
    </body>
</html>